#!/bin/sh
# Pre-commit hook - Quality gates before commit
# Install: cp .claude/templates/git-hooks/pre-commit .git/hooks/ && chmod +x .git/hooks/pre-commit

set -e

echo "ðŸ” Running pre-commit checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo "${GREEN}âœ“ No JS/TS files to check${NC}"
    exit 0
fi

# 1. ESLint
echo "\nðŸ“‹ Running ESLint..."
if command -v npx &> /dev/null && [ -f "package.json" ]; then
    if npx eslint $STAGED_FILES --quiet 2>/dev/null; then
        echo "${GREEN}âœ“ ESLint passed${NC}"
    else
        echo "${RED}âœ— ESLint failed${NC}"
        echo "${YELLOW}Run 'npm run lint:fix' to auto-fix issues${NC}"
        exit 1
    fi
else
    echo "${YELLOW}âš  ESLint not available, skipping${NC}"
fi

# 2. TypeScript
echo "\nðŸ”· Running TypeScript check..."
if command -v npx &> /dev/null && [ -f "tsconfig.json" ]; then
    if npx tsc --noEmit 2>/dev/null; then
        echo "${GREEN}âœ“ TypeScript passed${NC}"
    else
        echo "${RED}âœ— TypeScript errors found${NC}"
        exit 1
    fi
else
    echo "${YELLOW}âš  TypeScript not configured, skipping${NC}"
fi

# 3. Prettier (check only)
echo "\nðŸ’… Checking formatting..."
if command -v npx &> /dev/null && [ -f ".prettierrc" ] || [ -f ".prettierrc.json" ] || [ -f "prettier.config.js" ]; then
    if npx prettier --check $STAGED_FILES 2>/dev/null; then
        echo "${GREEN}âœ“ Formatting OK${NC}"
    else
        echo "${RED}âœ— Formatting issues found${NC}"
        echo "${YELLOW}Run 'npx prettier --write .' to fix${NC}"
        exit 1
    fi
else
    echo "${YELLOW}âš  Prettier not configured, skipping${NC}"
fi

# 4. Tests (optional - only if test files changed)
STAGED_TEST_FILES=$(echo "$STAGED_FILES" | grep -E '\.(test|spec)\.(ts|tsx|js|jsx)$' || true)
if [ -n "$STAGED_TEST_FILES" ]; then
    echo "\nðŸ§ª Running tests for changed files..."
    if command -v npx &> /dev/null; then
        if npx vitest run --passWithNoTests $STAGED_TEST_FILES 2>/dev/null || npx jest --passWithNoTests --findRelatedTests $STAGED_TEST_FILES 2>/dev/null; then
            echo "${GREEN}âœ“ Tests passed${NC}"
        else
            echo "${RED}âœ— Tests failed${NC}"
            exit 1
        fi
    fi
fi

# 5. Check for secrets
echo "\nðŸ”’ Checking for secrets..."
SECRETS_PATTERN='(password|secret|api_key|apikey|access_token|auth_token|credentials|private_key)\s*[:=]\s*["\x27][^"\x27]{8,}'
if echo "$STAGED_FILES" | xargs grep -iE "$SECRETS_PATTERN" 2>/dev/null; then
    echo "${RED}âœ— Potential secrets detected!${NC}"
    echo "${YELLOW}Please review the flagged lines above${NC}"
    exit 1
else
    echo "${GREEN}âœ“ No secrets detected${NC}"
fi

# 6. Check for console.log / debugger
echo "\nðŸ› Checking for debug statements..."
DEBUG_PATTERN='(console\.(log|debug|info)|debugger)'
if echo "$STAGED_FILES" | xargs grep -E "$DEBUG_PATTERN" 2>/dev/null | grep -v "// eslint-disable" | grep -v "// ok"; then
    echo "${YELLOW}âš  Debug statements found (consider removing)${NC}"
    # Warning only, don't block
fi

echo "\n${GREEN}âœ… All pre-commit checks passed!${NC}\n"
exit 0
