#!/bin/sh
# Commit-msg hook - Validate conventional commit format
# Install: cp .claude/templates/git-hooks/commit-msg .git/hooks/ && chmod +x .git/hooks/commit-msg

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Conventional commit pattern
# type(scope): description
# Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert
PATTERN='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-zA-Z0-9_-]+\))?: .{1,100}$'

# Allow merge commits
MERGE_PATTERN='^Merge '

# Allow revert commits
REVERT_PATTERN='^Revert '

# Get first line of commit message
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n 1)

# Skip validation for merge and revert commits
if echo "$FIRST_LINE" | grep -qE "$MERGE_PATTERN"; then
    exit 0
fi

if echo "$FIRST_LINE" | grep -qE "$REVERT_PATTERN"; then
    exit 0
fi

# Validate commit message
if ! echo "$FIRST_LINE" | grep -qE "$PATTERN"; then
    echo "${RED}✗ Invalid commit message format${NC}"
    echo ""
    echo "Expected format: ${YELLOW}type(scope): description${NC}"
    echo ""
    echo "Types:"
    echo "  feat     - New feature"
    echo "  fix      - Bug fix"
    echo "  docs     - Documentation"
    echo "  style    - Formatting (no code change)"
    echo "  refactor - Code refactoring"
    echo "  perf     - Performance improvement"
    echo "  test     - Adding tests"
    echo "  build    - Build system changes"
    echo "  ci       - CI configuration"
    echo "  chore    - Maintenance tasks"
    echo "  revert   - Revert previous commit"
    echo ""
    echo "Examples:"
    echo "  ${GREEN}feat(auth): add login with Google${NC}"
    echo "  ${GREEN}fix(api): resolve timeout on large requests${NC}"
    echo "  ${GREEN}docs: update README with new API endpoints${NC}"
    echo ""
    echo "Your message: ${RED}$FIRST_LINE${NC}"
    exit 1
fi

# Check description length
DESCRIPTION_LENGTH=$(echo "$FIRST_LINE" | wc -c)
if [ "$DESCRIPTION_LENGTH" -gt 100 ]; then
    echo "${YELLOW}⚠ Commit message first line should be < 100 chars (currently $DESCRIPTION_LENGTH)${NC}"
    # Warning only
fi

# Check for uppercase first letter after colon
TYPE_AND_SCOPE=$(echo "$FIRST_LINE" | sed 's/:.*//')
DESCRIPTION=$(echo "$FIRST_LINE" | sed 's/^[^:]*: //')
FIRST_CHAR=$(echo "$DESCRIPTION" | cut -c1)

if echo "$FIRST_CHAR" | grep -q '[A-Z]'; then
    echo "${YELLOW}⚠ Description should start with lowercase letter${NC}"
    # Warning only
fi

# Check for period at end
if echo "$FIRST_LINE" | grep -q '\.$'; then
    echo "${YELLOW}⚠ Description should not end with a period${NC}"
    # Warning only
fi

echo "${GREEN}✓ Commit message format valid${NC}"
exit 0
